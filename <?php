<?php
/*
Plugin Name: Stake Chart Plugin
Description: A WordPress plugin to display stake_watch charts.
Version: 1.0
Author: DSGN
*/

//calli9ng remote methods
$curl = curl_init();

curl_setopt_array($curl, array(
  CURLOPT_URL => 'https://stake-watch.onrender.com/get-chart',
  CURLOPT_RETURNTRANSFER => true,
  CURLOPT_ENCODING => '',
  CURLOPT_MAXREDIRS => 10,
  CURLOPT_TIMEOUT => 0,
  CURLOPT_FOLLOWLOCATION => true,
  CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
  CURLOPT_CUSTOMREQUEST => 'GET',
));

// Enqueue scripts and styles
function stake_watch_enqueue_scripts() {
    // Enqueue Chart.js library
    wp_enqueue_script('chartjs', 'https://cdn.jsdelivr.net/npm/chart.js', array(), '2.9.3', true);
    // Enqueue Font Awesome for icons
    wp_enqueue_style('font-awesome', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css');
}

add_action('wp_enqueue_scripts', 'stake_watch_enqueue_scripts');

// Function to convert timestamps to human-readable dates
function human_readable_date($timestamp) {
    return date('M j, Y', $timestamp);
}

// Function to filter data by time range
function filter_data_by_range($data, $range) {
    $filteredData = array();
    $currentDate = time(); // Current timestamp in seconds
    $rangeInSeconds = 0;

    switch ($range) {
        case '1m':
            $rangeInSeconds = 30 * 24 * 60 * 60; // 30 days
            break;
        case '3m':
            $rangeInSeconds = 90 * 24 * 60 * 60; // 90 days
            break;
        case '6m':
            $rangeInSeconds = 180 * 24 * 60 * 60; // 180 days
            break;
        case '1y':
            $rangeInSeconds = 365 * 24 * 60 * 60; // 365 days (1 year)
            break;
        default:
            return $data;
    }

    $cutoffDate = $currentDate - $rangeInSeconds;
    foreach ($data as $timestamp => $value) {
        if ($timestamp >= $cutoffDate) {
            $filteredData[$timestamp] = $value;
        }
    }

    return $filteredData;
}

// Register shortcode
function stake_watch_shortcode($atts) {
    // Extract shortcode attributes
    $atts = shortcode_atts(array(
        'type' => 'line', // Default chart type
        'range' => 'all', // Default time range
        'labels' => '', // Labels for data points
        'colors' => '', // Colors for data points
        'options' => '{}', // Additional chart options in JSON format
    ), $atts);
    
    // Sample data (replace with your actual data source or fetch from an external source)
    $data = {
		      "1635984000": 35573.600236294755,
        "1636070400": 35666.76170561703,
        "1636156800": 35690.880701944894,
        "1636243200": 35634.79244462109,
        "1636329600": 35694.401658442825,
        "1636416000": 35740.625513281186,
        "1636502400": 35779.33949565807,
        "1636588800": 35804.08272748432,
        "1636675200": 35938.225008670575,
        "1636761600": 36070.36277425588,
        "1636848000": 36154.483812968996,
        "1636934400": 36197.61469309544,
        "1637020800": 36241.21639131934,
        "1637107200": 36265.92863569351,
        "1637193600": 36251.02483714987,
        "1637280000": 36247.014197504766,
        "1637366400": 36257.55368332954,
        "1637452800": 36286.14592949864,
        "1637539200": 36314.68368016182,
        "1637625600": 36334.402083373,
        "1637712000": 36358.5109292188,
        "1637798400": 36391.12422789229,
        "1637884800": 36395.971638215866,
        "1637971200": 36389.67738681537,
        "1638057600": 36416.9916894782,
        "1638144000": 36420.5311946979,
        "1638230400": 36467.25647514561,
        "1638316800": 36552.09297403069,
        "1638403200": 36570.10935964384,
        "1638489600": 36627.542294869185,
        "1638576000": 36666.35467446205,
        "1638662400": 36651.817860877236,
        "1638748800": 36616.70591217472,
        "1638835200": 36659.43896801249,
        "1638921600": 36689.01395465773,
        "1639008000": 36669.94522192602,
        "1639094400": 36715.08772155784,
        "1639180800": 36715.54582552302,
        "1639267200": 36760.58574839569,
        "1639353600": 36785.05967875177,
        "1639440000": 36829.74315873473,
        "1639526400": 36826.8428293319,
        "1639612800": 36803.2761802135,
        "1639699200": 36905.34326942696,
        "1639785600": 36959.945732186956,
        "1639872000": 36992.36228786884,
        "1639958400": 37020.647184191024,
        "1640044800": 37101.01511438068,
        "1640131200": 37138.61157672567,
        "1640217600": 37172.01790065048,
        "1640304000": 37237.630001409576,
        "1640390400": 37274.96346336255,
        "1640476800": 37311.58616249845,
        "1640563200": 37386.010769888686,
        "1640649600": 37453.99618806845,
        "1640736000": 37594.80245106878,
        "1640822400": 37737.19296570169,
        "1640908800": 37810.22978817787,
        "1640995200": 37810.22978817787,
        "1641081600": 37909.19927032743,
        "1641168000": 37978.489273896266,
        "1641254400": 38137.89794835038,
        "1641340800": 38231.347469021224,
        "1641427200": 38271.308544403044,
        "1641513600": 38457.01191131943,
        "1641600000": 38429.6903569991,
        "1641686400": 38511.62045231325,
        "1641772800": 38572.392625062595,
        "1641859200": 38711.119644511346,
        "1641945600": 38799.216131058056,
        "1642032000": 39029.96022450939,
        "1642118400": 39142.20089726039,
        "1642204800": 39214.7075337613,
        "1642291200": 39257.86220037948,
        "1642377600": 39377.747815690345,
        "1642464000": 39482.8204333268,
        "1642550400": 39539.80077372746,
        "1642636800": 39804.62986544852,
        "1642723200": 40015.9704797049,
        "1642809600": 40117.90585191534,
        "1642896000": 40223.631168846914,
        "1642982400": 40479.097047215095,
        "1643068800": 40623.37456550263,
        "1643155200": 40680.75162290067,
        "1643241600": 40829.44629915072,
        "1643328000": 40840.34729879777,
        "1643414400": 41051.086422323875,
        "1643500800": 41156.513713092674,
        "1643587200": 41130.0077297014,
        "1643673600": 41270.35371451298,
        "1643760000": 41353.343064635636,
        "1643846400": 41478.2758075651,
        "1643932800": 41669.1447516237,
        "1644019200": 41841.73167345106,
        "1644105600": 41941.32608247405,
        "1644192000": 42094.331159353635,
        "1644278400": 42297.510517750605,
        "1644364800": 42447.36895585254,
        "1644451200": 42724.28081418171,
        "1644537600": 42786.62573330272,
        "1644624000": 43131.431694385465,
        "1644710400": 43320.52155162036,
        "1644796800": 43552.385539204966,
        "1644883200": 43680.34020346353,
        "1644969600": 43957.05328325577,
        "1645056000": 44038.262491300426,
        "1645142400": 44396.9138741158,
        "1645228800": 44443.23141516056,
        "1645315200": 44572.25646470301,
        "1645401600": 44735.45500244267,
        "1645488000": 44956.70437456131,
        "1645574400": 45260.119580204584,
        "1645660800": 45725.241374049176,
        "1645747200": 45862.42320441553,
        "1645833600": 46051.13901654037,
        "1645920000": 46171.07321850914,
        "1646006400": 46356.76286462312,
        "1646092800": 46338.477059645185,
        "1646179200": 46531.602292881886,
        "1646265600": 46673.45784676907,
        "1646352000": 46707.654769783694,
        "1646438400": 46791.89522737665,
        "1646524800": 46820.920412183375,
        "1646611200": 47213.40412781269,
        "1646697600": 47285.23816477711,
        "1646784000": 47422.82379044707,
        "1646870400": 47402.80024473752,
        "1646956800": 47610.84650717049,
        "1647043200": 47501.17526574017,
        "1647129600": 47466.12323988734,
        "1647216000": 47380.70831107377,
        "1647302400": 47257.79937633943,
        "1647388800": 47179.26587169632,
        "1647475200": 47297.00495437485,
        "1647561600": 47202.16878285469,
        "1647648000": 47197.22330774695,
        "1647734400": 47115.50500771785,
        "1647820800": 47120.16291212925,
        "1647907200": 47064.21389313108,
        "1647993600": 47104.475987389356,
        "1648080000": 47119.043734143605,
        "1648166400": 47016.78583166703,
        "1648252800": 46861.67440004062,
        "1648339200": 46856.281860492905,
        "1648425600": 46777.03286635734,
        "1648512000": 46569.8641550683,
        "1648598400": 46543.17703062161,
        "1648684800": 46530.6736880622,
        "1648771200": 46500.46218057333,
        "1648857600": 46679.12252241554,
        "1648944000": 46605.45602973833,
        "1649030400": 46514.7644427442,
        "1649116800": 46564.77611110092,
        "1649203200": 46497.53210700955,
        "1649289600": 46593.26965499048,
        "1649376000": 46420.405476112704,
        "1649462400": 46355.69332520811,
        "1649548800": 46249.51855113596,
        "1649635200": 46247.15590034314,
        "1649721600": 46219.23019495712,
        "1649808000": 46040.34380477867,
        "1649894400": 45909.85731913203,
        "1649980800": 45955.7462672042,
        "1650067200": 45891.244011580806,
        "1650153600": 45817.42695853096,
        "1650240000": 45834.56227842104,
        "1650326400": 45689.35168553169,
        "1650412800": 45599.22823457787,
        "1650499200": 45555.50873489729,
        "1650585600": 45417.1416641715,
        "1650672000": 45341.62499328341,
        "1650758400": 45305.88269102324,
        "1650844800": 45256.76097725383,
        "1650931200": 45202.10976919526,
        "1651017600": 45069.88831287322,
        "1651104000": 44882.68040183674,
        "1651190400": 44829.386190619385,
        "1651276800": 44758.1189412383,
        "1651363200": 44573.20180718559,
        "1651449600": 44541.50543993496,
        "1651536000": 44413.058619884025,
        "1651622400": 44307.016809220964,
        "1651708800": 44190.49136631996,
        "1651795200": 44178.65303988108,
        "1651881600": 44057.990906163526,
        "1651968000": 43949.45291803167,
        "1652054400": 43742.74610502943,
        "1652140800": 43660.92561935205,
        "1652227200": 43519.95106070354,
        "1652313600": 43366.310841886334,
        "1652400000": 43352.80329934646,
        "1652486400": 43164.364249724415,
        "1652572800": 43078.21214808851,
        "1652659200": 43054.63283476932,
        "1652745600": 42965.79731067729,
        "1652832000": 42947.97023231846,
        "1652918400": 42901.553472931104,
        "1653004800": 42865.40376325238,
        "1653091200": 42704.496987620885,
        "1653177600": 42625.28443963393,
        "1653264000": 42548.22860454845,
        "1653350400": 42431.795935551934,
        "1653436800": 42325.75092239885,
        "1653523200": 42262.015349892215,
        "1653609600": 42238.252571404424,
        "1653696000": 42199.40170326274,
        "1653782400": 42147.56223445588,
        "1653868800": 42094.277104715424,
        "1653955200": 42093.37157471962,
        "1654041600": 41984.24017895439,
        "1654128000": 41937.843840054884,
        "1654214400": 41937.634822777785,
        "1654300800": 41862.20951287627,
        "1654387200": 41831.36060061786,
        "1654473600": 41799.26412019217,
        "1654560000": 41764.40313769337,
        "1654646400": 41661.515499457506,
        "1654732800": 41589.227423333425,
        "1654819200": 41635.05796426132,
        "1654905600": 41560.88025597193,
        "1654992000": 41434.67092339113,
        "1655078400": 41423.33091219685,
        "1655164800": 41315.1288636744,
        "1655251200": 41225.539879739306,
        "1655337600": 41104.32249587235,
        "1655424000": 41044.991602135095,
        "1655510400": 41011.69979217124,
        "1655596800": 40778.22568555725,
        "1655683200": 40746.119490971076,
        "1655769600": 40629.52276288545,
        "1655856000": 40598.51855859908,
        "1655942400": 40516.88719890478,
        "1656028800": 40561.2701748335,
        "1656115200": 40486.25426901146,
        "1656201600": 40484.405869565046,
        "1656288000": 40498.892692484456,
        "1656374400": 40430.72602404073,
        "1656460800": 40339.28315176926,
        "1656547200": 40329.57176132067,
        "1656633600": 40214.99573984291,
        "1656720000": 40075.30281443039,
        "1656806400": 39946.88798765769,
        "1656892800": 39944.83752650822,
        "1656979200": 39875.77671855214,
        "1657065600": 39836.3052624625,
        "1657152000": 39791.5744203709,
        "1657238400": 39688.00195856825,
        "1657324800": 39719.043993076935,
        "1657411200": 39694.357360546135,
        "1657497600": 39619.32295555047,
        "1657584000": 39539.0607021505,
        "1657670400": 39388.43968844123,
        "1657756800": 39350.18472295483,
        "1657843200": 39255.42587882871,
        "1657929600": 39309.32622705067,
        "1658016000": 39315.71784335085,
        "1658102400": 39310.80039688493,
        "1658188800": 39245.11759014778,
        "1658275200": 39244.17324911226,
        "1658361600": 39078.34917708483,
        "1658448000": 39037.75888406147,
        "1658534400": 38990.53767626043,
        "1658620800": 38867.195290394986,
        "1658707200": 38728.20526531478,
        "1658793600": 38585.27154615791,
        "1658880000": 38418.35691425654,
        "1658966400": 38352.23931594347,
        "1659052800": 38352.894760579315,
        "1659139200": 38342.54616646075,
        "1659225600": 38307.84721810355,
        "1659312000": 38329.54070047529,
        "1659398400": 38274.04636565064,
        "1659484800": 38354.35569563219,
        "1659571200": 38403.80827021549,
        "1659657600": 38322.02931176032,
        "1659744000": 38323.21322884307,
        "1659830400": 38318.87500793783,
        "1659916800": 38326.04188628052,
        "1660003200": 38258.26459982935,
        "1660089600": 38264.04187144613,
        "1660176000": 38280.83612410939,
        "1660262400": 38260.08478434077,
        "1660348800": 38123.12447226922,
        "1660435200": 38105.77515602835,
        "1660521600": 38076.1957740854,
        "1660608000": 37840.93095040571,
        "1660694400": 37782.44085142939,
        "1660780800": 37838.08206052618,
        "1660867200": 37845.422173449835,
        "1660953600": 37756.01873392076,
        "1661040000": 37711.88706607386,
        "1661126400": 37849.4424076074,
        "1661212800": 37859.00742605753,
        "1661299200": 37780.72139526793,
        "1661385600": 37667.14670714539,
        "1661472000": 37630.932225715755,
        "1661558400": 37549.06490754002,
        "1661644800": 37570.31949875517,
        "1661731200": 37495.198206198795,
        "1661817600": 37460.4666594836,
        "1661904000": 37455.84008803464,
        "1661990400": 37437.412736818995,
        "1662076800": 37434.491337523476,
        "1662163200": 37397.25779826466,
        "1662249600": 37371.67243746186,
        "1662336000": 37320.175237771895,
        "1662422400": 37330.553913491494,
        "1662508800": 37323.743864078664,
        "1662595200": 37343.54176735768,
        "1662681600": 37288.44833612446,
        "1662768000": 37268.17132349782,
        "1662854400": 37184.33066980442,
        "1662940800": 37021.95376849852,
        "1663027200": 37016.533193512456,
        "1663113600": 37005.200208461116,
        "1663200000": 37064.140941396516,
        "1663286400": 36937.10937749421,
        "1663372800": 36863.317209658824,
        "1663459200": 36796.655869646136,
        "1663545600": 36805.95547509047,
        "1663632000": 36772.95955803701,
        "1663718400": 36665.29848910693,
        "1663804800": 36640.110933593096,
        "1663891200": 36715.72054669854,
        "1663977600": 36766.35156778484,
        "1664064000": 36672.49355162785,
        "1664150400": 36634.39671139965,
        "1664236800": 36483.58235466861,
        "1664323200": 36492.5426756521,
        "1664409600": 36421.20736616963,
        "1664496000": 36397.05146385528,
        "1664582400": 36371.47340261954,
        "1664668800": 36363.822948348716,
        "1664755200": 36442.117048764,
        "1664841600": 36373.15315188575,
        "1664928000": 36375.88022346142,
        "1665014400": 36384.82356721481,
        "1665100800": 36388.181142621506,
	};
    // Filter data based on the selected time range
    $filtered_data = filter_data_by_range($data, $atts['range']);

    // Generate chart using filtered data and shortcode attributes
    ob_start();
    ?>
    <div style="position: relative; max-height:300px
				">
        <canvas id="stakeChart" width="300" height="300"></canvas>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var ctx = document.getElementById('stakeChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: '<?php echo $atts['type']; ?>',
                data: {
                    labels: <?php echo json_encode(array_map('human_readable_date', array_keys($filtered_data))); ?>,
                    datasets: [{
                        label: ' ',
                        data: <?php echo json_encode(array_values($filtered_data)); ?>,
                        backgroundColor: 'transparent',
                        borderColor: createGradient(ctx), 
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        xAxes: [{
                            gridLines: {
                                display: false // Remove vertical grid lines
                            }
                        }],
                        yAxes: [{
                            ticks: {
                                callback: function(value, index, values) {
                                    return '$' + value; // Show price label on hover
                                }
                            }
                        }]
                    },
                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, data) {
                                return '$' + tooltipItem.yLabel.toFixed(2);
                            }
                        }
                    }
                }
            });
        });

        // Function to create gradient
        function createGradient(ctx) {
            var gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, '#dabe2a'); // Start color
            gradient.addColorStop(1, '#4cf816'); // End color
            return gradient;
        }
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('stake_watch', 'stake_watch_shortcode');
?>